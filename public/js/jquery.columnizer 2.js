// version 1.6.0
// http://welcome.totheinter.net/columnizer-jquery-plugin/
// created by: Adam Wulf @adamwulf, adam.wulf@gmail.com

!function(e){e.fn.columnize=function(t){var n={width:400,columns:!1,buildOnce:!1,overflow:!1,doneFunc:function(){},target:!1,ignoreImageLoading:!0,columnFloat:"left",lastNeverTallest:!1,accuracy:!1,manualBreaks:!1,cssClassPrefix:""};return"string"==typeof(t=e.extend(n,t)).width&&(t.width=parseInt(t.width,10),isNaN(t.width)&&(t.width=n.width)),this.each(function(){var o=t.target?e(t.target):e(this),i=e(this).height(),l=e("<div></div>"),a=0,d=t.manualBreaks,r=n.cssClassPrefix;"string"==typeof t.cssClassPrefix&&(r=t.cssClassPrefix);if(l.append(e(this).contents().clone(!0)),!t.ignoreImageLoading&&!t.target&&!o.data("imageLoaded")&&(o.data("imageLoaded",!0),e(this).find("img").length>0)){var s=function(e,n){return function(){e.data("firstImageLoaded")||(e.data("firstImageLoaded","true"),e.empty().append(n.children().clone(!0)),e.columnize(t))}}(e(this),l);return e(this).find("img").one("load",s),void e(this).find("img").one("abort",s)}function c(e,t){var n=t?".":"";return r.length?n+r+"-"+e:n+e}function h(n,o,i,l){for(;(d||i.height()<l)&&o[0].childNodes.length;){var a=o[0].childNodes[0];if(e(a).find(c("columnbreak",!0)).length)return;if(e(a).hasClass(c("columnbreak")))return;n.append(a)}if(0!==n[0].childNodes.length){var r=n[0].childNodes,s=r[r.length-1];n[0].removeChild(s);var h=e(s);if(3==h[0].nodeType){var f,u=h[0].nodeValue,g=t.width/18;t.accuracy&&(g=t.accuracy);for(var m=null;i.height()<l&&u.length;){var v=u.indexOf(" ",g);f=-1!=v?u.substring(0,u.indexOf(" ",g)):u,m=document.createTextNode(f),n.append(m),u=u.length>g&&-1!=v?u.substring(v):""}if(i.height()>=l&&null!==m&&(n[0].removeChild(m),u=m.nodeValue+u),!u.length)return!1;h[0].nodeValue=u}return o.contents().length?o.prepend(h):o.append(h),3==h[0].nodeType}}function f(e,t,n,o){if(!e.contents(":last").find(c("columnbreak",!0)).length&&!e.contents(":last").hasClass(c("columnbreak"))&&t.contents().length){var i=t.contents(":first");if(1!=i.get(0).nodeType)return;var l=i.clone(!0);i.hasClass(c("columnbreak"))?(e.append(l),i.remove()):d?(e.append(l),i.remove()):1!=l.get(0).nodeType||l.hasClass(c("dontend"))||(e.append(l),l.is("img")&&n.height()<o+20?i.remove():!i.hasClass(c("dontsplit"))&&n.height()<o+20?i.remove():l.is("img")||i.hasClass(c("dontsplit"))?l.remove():(l.empty(),h(l,i,n,o)?i.addClass(c("split")):(i.addClass(c("split")),i.children().length&&f(l,i,n,o)),0===l.get(0).childNodes.length&&l.remove()))}}function u(){if(!o.data("columnized")||1!=o.children().length){if(o.data("columnized",!0),o.data("columnizing",!0),o.empty(),o.append(e("<div class='"+c("first")+" "+c("last")+" "+c("column")+" ' style='width:100%; float: "+t.columnFloat+";'></div>")),$col=o.children().eq(o.children().length-1),$destroyable=l.clone(!0),t.overflow){for(targetHeight=t.overflow.height,h($col,$destroyable,$col,targetHeight),$destroyable.contents().find(":first-child").hasClass(c("dontend"))||f($col,$destroyable,$col,targetHeight);$col.contents(":last").length&&g($col.contents(":last").get(0));){var n=$col.contents(":last");n.remove(),$destroyable.prepend(n)}for(var i="",a=document.createElement("DIV");$destroyable[0].childNodes.length>0;){var d=$destroyable[0].childNodes[0];if(d.attributes)for(var r=0;r<d.attributes.length;r++)0===d.attributes[r].nodeName.indexOf("jQuery")&&d.removeAttribute(d.attributes[r].nodeName);a.innerHTML="",a.appendChild($destroyable[0].childNodes[0]),i+=a.innerHTML}e(t.overflow.id)[0].innerHTML=i}else $col.append($destroyable);o.data("columnizing",!1),t.overflow&&t.overflow.doneFunc&&t.overflow.doneFunc()}}function g(t){return 3==t.nodeType?!!/^\s+$/.test(t.nodeValue)&&(!!t.previousSibling&&g(t.previousSibling)):1==t.nodeType&&(!!e(t).hasClass(c("dontend"))||0!==t.childNodes.length&&g(t.childNodes[t.childNodes.length-1]))}function m(){if(0,a!=o.width()){a=o.width();var n=Math.round(o.width()/t.width),r=t.width,s=t.height;if(t.columns&&(n=t.columns),d&&(n=l.find(c("columnbreak",!0)).length+1,r=!1),n<=1)return u();if(!o.data("columnizing")){o.data("columnized",!0),o.data("columnizing",!0),o.empty(),o.append(e("<div style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>")),(N=o.children(":last")).append(l.clone()),i=N.height(),o.empty();var m=i/n,v=3,p=!1;t.overflow?(v=1,m=t.overflow.height):s&&r&&(v=1,m=s,p=!0);for(var w=0;w<v&&w<20;w++){var b,y,N,C;o.empty();try{b=l.clone(!0)}catch(e){b=l.clone()}b.css("visibility","hidden");for(var $=0;$<n;$++)y=0===$?c("first"):"",y+=" "+c("column"),y=$==n-1?c("last")+" "+y:y,o.append(e("<div class='"+y+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"));for($=0;$<n-(t.overflow?0:1)||p&&b.contents().length;){for(o.children().length<=$&&o.append(e("<div class='"+y+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>")),N=o.children().eq($),p&&N.width(r+"px"),h(N,b,N,m),f(N,b,N,m);N.contents(":last").length&&g(N.contents(":last").get(0));)(C=N.contents(":last")).remove(),b.prepend(C);$++,0===N.contents().length&&b.contents().length?N.append(b.contents(":first")):$!=n-(t.overflow?0:1)||t.overflow||b.find(c("columnbreak",!0)).length&&n++}if(t.overflow&&!p){if(document.all&&-1!=navigator.appVersion.indexOf("MSIE 7.")){for(var T="",x=document.createElement("DIV");b[0].childNodes.length>0;){var L=b[0].childNodes[0];for($=0;$<L.attributes.length;$++)0===L.attributes[$].nodeName.indexOf("jQuery")&&L.removeAttribute(L.attributes[$].nodeName);x.innerHTML="",x.appendChild(b[0].childNodes[0]),T+=x.innerHTML}e(t.overflow.id)[0].innerHTML=T}else e(t.overflow.id).empty().append(b.contents().clone(!0))}else if(p)o.children().each(function(e){(N=o.children().eq(e)).width(r+"px"),0===e?N.addClass(c("first")):e==o.children().length-1?N.addClass(c("last")):(N.removeClass(c("first")),N.removeClass(c("last")))}),o.width(o.children().length*r+"px");else{N=o.children().eq(o.children().length-1),b.contents().each(function(){N.append(e(this))});N.height();var M=0,z=1e7,k=0,F=!1,H=0;o.children().each(function(e){return function(t){var n=e.children().eq(t);if(!n.children(":last").find(c("columnbreak",!0)).length){var o=n.height();F=!1,M+=o,o>k&&(k=o,F=!0),o<z&&(z=o),H++}}}(o));var I=M/H;0===M?w=v:t.lastNeverTallest&&F?(30,m+=30,w==v-1&&v++):k-z>30?m=I+30:Math.abs(I-m)>20?m=I:w=v}o.append(e("<br style='clear:both;'>"))}o.find(c("column",!0)).find(":first"+c("removeiffirst",!0)).remove(),o.find(c("column",!0)).find(":last"+c("removeiflast",!0)).remove(),o.data("columnizing",!1),t.overflow&&t.overflow.doneFunc(),t.doneFunc()}}}o.empty(),m(),t.buildOnce||e(window).resize(function(){t.buildOnce||(o.data("timeout")&&clearTimeout(o.data("timeout")),o.data("timeout",setTimeout(m,200)))})})}}(jQuery);